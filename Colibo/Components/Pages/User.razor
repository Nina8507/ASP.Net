@page "/User"
@using Colibo.Models
@using Colibo.Service
@inject IMergedData_Service _service
@inject NavigationManager _navManager
@inject ILogger<Home> logger

<h3>Employees</h3>

<p>Search by Name: <input type="text" @oninput="@((arg) => SearchById(arg))" style="width : 400px" /></p>

@if(toShow == null)
{
  <p><em>Loading...</em>></p>
}
else 
{
  <table class="table table-striped">
    <thred>
      <tr>
        <th scope="col">EmployeeId</th>
        <th scope="col">Name</th>
        <th scope="col">Email</th>
        <th scope="col">Mobile</th>
        <th scope="col">Title</th>
        <th scope="col">Address</th>
        <th scope="col">City</th>
        <th scope="col">Delete</th>
        <th scope="col">Edit</th>
      </tr>
    </thred>

    <tbody>
      @foreach (var p in toShow)
      {
        <tr>
          <td>@p.Id</td>
          <td>@p.FullName</td>
          <td>@p.Email</td>
          <td>@p.Mobile</td>
          <td>@p.JobTitle</td>
          <td>@p.Address</td>
          <td>@p.City</td>
          <td>
            <button class="delete-button" @onclick="@(() => DeleteAsync(p.Id!))"></button>
          </td>
          <td>
            <button class="edit-button"  @onclick="@(() => UpdateAsync(p.Id!))"></button>
          </td>
        </tr>
      }
    </tbody>
  </table>
}

@code 
{
  private List<MergedUsers> toShow = new();
  private List<MergedUsers> filter = new();
  private string? filterById; 

  protected override async Task OnInitializedAsync()
  {
    toShow = await _service.GetAllAsync();
    logger.LogInformation($"List size is: {toShow.Count}");
  }

  private async Task DeleteAsync(string id)
  {
    await _service.DeleteAsync(id);
    var toRemove = toShow.FirstOrDefault(p => p.Id!.Equals(id!));
    toShow.Remove(toRemove!);
  }

  private void UpdateAsync(string id)
  {
    _navManager.NavigateTo($"Edit/{id}");
  }

  private void SearchById(ChangeEventArgs changeEvent)
  {
    filterById = null;
    try
    {
      filterById = changeEvent.Value!.ToString();
    }
    catch(Exception e)
    {
      Console.WriteLine(e);
      throw;
    }
    ExecuteSearch();
  }

  private void ExecuteSearch()
  {
     if (string.IsNullOrWhiteSpace(filterById))
    {
        toShow = filter.ToList();
    }
    else
    {
        toShow = filter.Where(p => p.FullName != null && 
                                    p.FullName.Equals(filterById, StringComparison.OrdinalIgnoreCase))
                      .ToList();
    }
  }
}